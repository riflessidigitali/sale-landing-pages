name: Create recurring tasks

on: 
  schedule:
    - cron: 0 0 * * MON # Every week on Monday at midnight UTC.
  workflow_dispatch:  

jobs:
  create-issue:
    name: Create issue
    runs-on: ubuntu-latest
    steps:
      - name: Set issue due date
        run: echo "ISSUE_DUE_DATE=$(date -d "next fri 22 UTC")" >> $GITHUB_ENV
      - name: Create issue
        env:
          GH_TOKEN: ${{ secrets.IPJ_ISSUE_MANAGE_PAT }}
          GH_REPO: ${{ github.repository }}
          TITLE: '[Recurring] Plugin and Theme updates'
          DATE: $(date -d "next fri 22 UTC")
          BODY: |
            Perform Plugin and Theme updates on the website.
            Due by: ${{ env.ISSUE_DUE_DATE }}
        run: |
          PREV_ISSUE_NUM=$(gh issue list --search "$TITLE" --state open --json number --jq '.[0].number')
          if [[ -n $PREV_ISSUE_NUM ]]; then
            echo "An issue already exists for "$TITLE", see issue #$PREV_ISSUE_NUM"
          else
            gh issue create --title "$TITLE" --body "$BODY"
          fi
